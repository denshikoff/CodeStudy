program Test_tusk;
{Проверить правильность расстановки скобок 3-х типов в выражении.}
{$APPTYPE CONSOLE}

uses
  SysUtils, UStack, Windows;
const
  open = ['(', '[', '{'];
  close = [')', ']', '}'];


var
  S : String;
  Res : Integer;
 
//Для закрывающей скобки возвращает соответствующую открывающую скобку.
function GetOpen(const aCh : Char) : Char;
begin
  GetOpen := #0;
  case aCh of
    ')' : GetOpen := '(';
    ']' : GetOpen := '[';
    '}' : GetOpen := '{';
  else
    Writeln('function GetOpen. Ошибка.');
  end;
end;



function ParsePh(const aStr : String) : Integer;
var
  Stack : TStack;
  i, Res : Integer;
  Ch : Char;
begin
  //?????????????? ????.
  Stack.top := 0;
 
  //0 - ???????.
  Res := 0;
  for i := 1 to Length(aStr) do
    if aStr[i] in open then begin
      //????? ??????????? ?????? - ????????? ?? ? ????.
      if not PushStack(Stack, aStr[i]) then begin
        //-2 - ???????????? ?????.
        Res := -2;
        Break;
      end;
    end else if aStr[i] in close then begin;
      //????? ?????????? ?????? - ????? ??????? ?? ??????? ?????.
      if PopStack(Stack, Ch) then begin
        //???? ?? ????.
        if Ch <> GetOpen(aStr[i]) then begin
          //?????? ?? ??????? ????? ?????? ?? ????????????? ??????? ??????????? ??????.
          //??????????????? ????????.
          //(Res > 0) - ????????? ???????????, Res ????? ??????? ??????? (??????) ?? ???????
          //????????? ????????? ??????????????? ??????.
          Res := i;
          Break;
        end;
      end else begin
        //???? ????. ?????? ??? ???????????? ??? ??????? ??????????? ??????.
        //??????????????? ????????.
        //(Res > 0) - ????????? ???????????, Res ????? ??????? ??????? (??????) ?? ???????
        //????????? ????????? ??????????????? ??????.
        Res := i;
        Break;
      end;
    end;
 
  if Res = 0 then begin
    //???? ???? ???? - ?????? ???????????. ????? - ?? ???????????.
    //-1 - ?? ??????? ??????????? ??????.
    if PopStack(Stack, Ch) then Res := -1;
  end;
 
  ParsePh := Res;
end;


begin
  SetConsoleCP(1251);
  SetConsoleOutputCp(1251);
  repeat
    Writeln('Введите строку:');
    Readln(S);
 
    Res := ParsePh(S);
    case Res of
      -2 : Writeln('Ошибка!Переполнение стека.');
      -1 : Writeln('Не хватает закрывающихся скобок.');
      0  : Writeln('Скобки согласованы.');
      else
        Writeln('Скобкине несогласованы');
    end;

    Writeln('Повторить - Enter, выход любой другой символ + Enter.');
    Readln(S);
  until S <> '';
end.
